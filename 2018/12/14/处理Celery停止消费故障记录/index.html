<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Celery故障处理 | LionCui的IT二三事</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Celery故障处理</h1><a id="logo" href="/.">LionCui的IT二三事</a><p class="description">分享与记录</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Celery故障处理</h1><div class="post-meta">Dec 14, 2018</div><div class="post-content"><h1 id="处理Celery停止消费故障记录"><a href="#处理Celery停止消费故障记录" class="headerlink" title="处理Celery停止消费故障记录"></a>处理Celery停止消费故障记录</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>某段时间, 正常运行的celery定时任务就会忽然停止运行, <code>celery_beat</code> 和 <code>celery_worker</code> 进程并无异常</p>
<p>首先做了以下排查</p>
<ol>
<li>task 是否抛出异常导致整个task没有产生正常结果？</li>
<li>消息队列是否异常导致task丢失？</li>
<li>是否性能问题导致task处理不过来?</li>
</ol>
<p>在明确排除了以上原因后, 开始了深入的问题分析</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="检查日志"><a href="#检查日志" class="headerlink" title="检查日志"></a>检查日志</h3><p> 查看日志发现<code>celery_worker</code> 最后接收了一些任务后就没有继续接收, 且这些任务并有正常返回<code>result</code>, 定时器执行的时候, 发送出去的任务, 也是没有接收到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(venv) [webapi@VM_231_194_centos <span class="built_in">log</span>]$ tail -f worker_err.log </span><br><span class="line">[2018-12-12 13:22:09,110: INFO/MainProcess] Received task: task.send_mail[648a580f-dae1-4a8e-9adc-924183e8226c]</span><br><span class="line">[2018-12-12 13:22:09,374: INFO/MainProcess] Received task: task.send_mail[02afd467-4e13-4420-a769-d05c1e003a6c]</span><br><span class="line">[2018-12-12 13:23:10,959: INFO/MainProcess] Received task: task.send_mail[7e6f5656-d222-4095-81d4-ca56b86daed5]</span><br><span class="line">[2018-12-12 13:23:11,285: INFO/MainProcess] Received task: task.send_mail[69d1dd2a-9eae-4d2d-b556-f933243b3bfb]</span><br><span class="line">[2018-12-12 13:30:05,584: INFO/MainProcess] Received task: task.send_mail[bbc271a1-b88b-4b9c-b2d8-e446f26ddb96]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此celery_worker 除了执行schedule调度的定时任务以外， 还有实时的异步任务例如发送邮件</p>
</blockquote>
<h2 id="检查状态"><a href="#检查状态" class="headerlink" title="检查状态"></a>检查状态</h2><p>从<code>stats</code> 可以得出一些信息, <code>worker</code>  跑了4个子进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(venv) [webapi@VM_231_194_centos current]$ celery -A celery_worker:celery inspect stats</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"pid"</span>: 22644,</span><br><span class="line">        <span class="string">"pool"</span>: &#123;</span><br><span class="line">            <span class="string">"max-concurrency"</span>: 4,</span><br><span class="line">            <span class="string">"max-tasks-per-child"</span>: <span class="string">"N/A"</span>,</span><br><span class="line">            <span class="string">"processes"</span>: [</span><br><span class="line">                22655,</span><br><span class="line">                22657,</span><br><span class="line">                22666,</span><br><span class="line">                22667</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"put-guarded-by-semaphore"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"timeouts"</span>: [</span><br><span class="line">                0,</span><br><span class="line">                0</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"writes"</span>: &#123;</span><br><span class="line">                <span class="string">"all"</span>: <span class="string">"24.99%, 25.01%, 25.01%, 24.99%"</span>,</span><br><span class="line">                <span class="string">"avg"</span>: <span class="string">"25.00%"</span>,</span><br><span class="line">                <span class="string">"inqueues"</span>: &#123;</span><br><span class="line">                    <span class="string">"active"</span>: 0,</span><br><span class="line">                    <span class="string">"total"</span>: 4</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"raw"</span>: <span class="string">"1196, 1197, 1197, 1196"</span>,</span><br><span class="line">                <span class="string">"total"</span>: 4786</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>reserved</code> 查看目前接收等待处理的<code>task</code>数量是16, 粗略地估算了一下task大小(与传递的数据相关), 16个任务大小已经接近64K</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(venv) [webapi@VM_231_194_centos current]$ celery -A celery_worker:celery inspect reserved | grep -v <span class="string">"OK"</span> | wc -l</span><br><span class="line">16</span><br></pre></td></tr></table></figure>
<p>通过<code>active</code> 找到目前<code>worker</code> 只有一个进行中的任务, 并且这个任务已经超时了非常长的时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(venv) [webapi@VM_231_194_centos current]$ celery -A celery_worker:celery inspect active | grep -v <span class="string">"OK"</span> | wc -l</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<h2 id="思考过程"><a href="#思考过程" class="headerlink" title="思考过程"></a>思考过程</h2><p><code>celery_worker</code> 是多进程来接收处理任务, 返回任务的结果, 问题是出在<code>active</code>的任务明明只有一个, 为什么所有子进程都没法处理其他已经接收的任务呢？这会不会是<code>worker</code>的消费模型导致？从官网的资料入手, 里面有<a href="http://docs.celeryproject.org/en/latest/userguide/optimizing.html#prefork-pool-prefetch-settings" target="_blank" rel="noopener">prefork-pool-prefetch-settings</a> 说明 </p>
<blockquote>
<ol>
<li>worker 根据配置fork一些子进程</li>
<li>父进程通过消息队列获取任务</li>
<li>父进程通过管道向子进程发送任务</li>
<li>子进程接收处理任务并返回结果</li>
</ol>
</blockquote>
<p><code>prefectch-settings</code> 是让父进程往<code>pipe</code>里面异步发送<code>task</code> , <code>pipe</code>缓冲区大小默认64KB(部分系统可能是1MB), 如果子进程A执行长时间某个任务, 这时候<code>pipe</code> 来了一些<code>task</code>是需要A接收的, 如果刚好缓冲区满了, 主进程发送给A时被阻塞那么所有其他子进程都无法通过<code>pipe</code> 接收任务</p>
<p>以下是伪代码演示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-&gt; send task T1 to process A</span><br><span class="line"><span class="comment"># A executes T1</span></span><br><span class="line">-&gt; send task T2 to process B</span><br><span class="line"><span class="comment"># B executes T2</span></span><br><span class="line">&lt;- T2 complete sent by process B</span><br><span class="line"></span><br><span class="line">-&gt; send task T3 to process A</span><br><span class="line"><span class="comment"># A still executing T1, T3 stuck in local buffer and won't start until</span></span><br><span class="line"><span class="comment"># T1 returns, and other queued tasks won't be sent to idle processes</span></span><br><span class="line">&lt;- T1 complete sent by process A</span><br><span class="line"><span class="comment"># A executes T3</span></span><br></pre></td></tr></table></figure>
<p>流程图如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">父进程 --&gt; |1.发送任务A1| 管道A&#123;管道A&#125;</span><br><span class="line">父进程 --&gt; |8.发送任务A2, 缓冲区满, 阻塞父进程| 管道A&#123;管道A&#125;</span><br><span class="line">父进程 --&gt; |4.发送任务B1| 管道B&#123;管道B&#125;</span><br><span class="line">管道A --&gt;|2.接收任务A1| A[子进程A]</span><br><span class="line">管道B --&gt;|5.接收任务B1| B[子进程B]</span><br><span class="line">A --&gt; |3.处理任务| 子进程A的IO</span><br><span class="line">B --&gt; |6.处理任务| 子进程B的IO</span><br><span class="line">子进程B的IO --&gt; |7.返回结果| 消息队列</span><br></pre></td></tr></table></figure>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p><code>worker</code>  提供<code>-Ofair</code> 参数来禁用这种<code>prefetch-settings</code></p>
<p>启动这个参数后, 主进程只会向当前可用的<code>PIPE</code> 发送数据</p>
<p>以下是伪代码演示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-&gt; send task T1 to process A</span><br><span class="line"><span class="comment"># A executes T1</span></span><br><span class="line">-&gt; send task T2 to process B</span><br><span class="line"><span class="comment"># B executes T2</span></span><br><span class="line">&lt;- T2 complete sent by process B</span><br><span class="line"></span><br><span class="line">-&gt; send T3 to process B</span><br><span class="line"><span class="comment"># B executes T3</span></span><br><span class="line"></span><br><span class="line">&lt;- T3 complete sent by process B</span><br><span class="line">&lt;- T1 complete sent by process A</span><br></pre></td></tr></table></figure>
<p>上面只是避开来遇到长期阻塞的子进程,极端的情况下有可能全部子进程都被阻塞, 所以我们针对<code>task</code>应该要有超时设置来保证这个错误能被正确处理. 由于问题是因为<code>send_mail</code> 这个任务引起, 所以我们要对这个任务进行时间限制, 只要超出来时间, 就自动抛出<code>SoftTimeLimitExceeded</code> 而不是无限期等待</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@celery.task(name='task.send_mail',soft_time_limit=20)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">async_send_email</span><span class="params">(title, html_content, recipients)</span>:</span></span><br><span class="line">    msg = Message(title, recipients=recipients)</span><br><span class="line">    msg.html = html_content</span><br><span class="line">    mail.send(msg)</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://docs.celeryproject.org/en/latest/userguide/optimizing.htm" target="_blank" rel="noopener">celery optimizing</a></p>
<p><a href="http://docs.celeryproject.org/en/latest/userguide/workers.html" target="_blank" rel="noopener">celery userguide</a></p>
</div><div class="tags"><a href="/tags/Python/">Python</a></div><div class="post-nav"><a class="next" href="/2017/04/11/OTP动态密码实现与应用/">OTP动态密码实现与场景应用</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Openstack/" style="font-size: 15px;">Openstack</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MQTT/" style="font-size: 15px;">MQTT</a> <a href="/tags/Ceph/" style="font-size: 15px;">Ceph</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/VMware/" style="font-size: 15px;">VMware</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/处理Celery停止消费故障记录/">Celery故障处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/11/OTP动态密码实现与应用/">OTP动态密码实现与场景应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/19/MQTT实时推送设计/">MQTT实时推送设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/01/Golang为Python编写模块/">Golang为Python编写模块</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/06/Tkinter引入图标/">Tkinter如何引入图标</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/05/VPNaaS服务说明/">VPNaaS服务说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/22/LBaaS服务说明/">LBaaS服务说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/15/nova集成docker部署/">Nova集成Docker过程记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/23/自定义创建Openstack镜像(Windows)/">自定义制作Windows2008R2 nova镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/23/自定义制作centos6.6镜像/">自定义制作centos6.6 nova镜像</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">LionCui的IT二三事.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>